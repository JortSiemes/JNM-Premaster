"use strict";var e=require("obsidian"),t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function r(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function l(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}a((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}}function o(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function l(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}function a(e){return this instanceof a?(this.v=e,this):new a(e)}function c(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||l(e,t)}))})}function l(e,t){try{(n=i[e](t)).value instanceof a?Promise.resolve(n.value.v).then(c,u):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function c(e){l("next",e)}function u(e){l("throw",e)}function d(e,t){e(t),o.shift(),o.length&&l(o[0][0],o[0][1])}}function u(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=o(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,i,(t=e[n](t)).done,t.value)}))}}}function d(e){return"function"==typeof e}function h(e){var t=e((function(e){Error.call(e),e.stack=(new Error).stack}));return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var p=h((function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}}));function g(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var f=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._teardowns=null}var t;return e.prototype.unsubscribe=function(){var e,t,n,r,i;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var c=o(a),u=c.next();!u.done;u=c.next()){u.value.remove(this)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}else a.remove(this);var h=this.initialTeardown;if(d(h))try{h()}catch(e){i=e instanceof p?e.errors:[e]}var g=this._teardowns;if(g){this._teardowns=null;try{for(var f=o(g),v=f.next();!v.done;v=f.next()){var b=v.value;try{m(b)}catch(e){i=null!=i?i:[],e instanceof p?i=l(l([],s(i)),s(e.errors)):i.push(e)}}}catch(e){n={error:e}}finally{try{v&&!v.done&&(r=f.return)&&r.call(f)}finally{if(n)throw n.error}}}if(i)throw new p(i)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)m(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=null!==(n=this._teardowns)&&void 0!==n?n:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&g(t,e)},e.prototype.remove=function(t){var n=this._teardowns;n&&g(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}(),v=f.EMPTY;function b(e){return e instanceof f||e&&"closed"in e&&d(e.remove)&&d(e.add)&&d(e.unsubscribe)}function m(e){d(e)?e():e.unsubscribe()}var C={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},y={setTimeout:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=y.delegate;return((null==n?void 0:n.setTimeout)||setTimeout).apply(void 0,l([],s(e)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function w(e){y.setTimeout((function(){throw e}))}function T(){}function S(e){e()}var k=function(e){function t(t){var n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,b(t)&&t.add(n)):n.destination=P,n}return n(t,e),t.create=function(e,t,n){return new x(e,t,n)},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(f),x=function(e){function t(t,n,r){var i,o=e.call(this)||this;if(d(t))i=t;else if(t){var s;i=t.next,n=t.error,r=t.complete,o&&C.useDeprecatedNextContext?(s=Object.create(t)).unsubscribe=function(){return o.unsubscribe()}:s=t,i=null==i?void 0:i.bind(s),n=null==n?void 0:n.bind(s),r=null==r?void 0:r.bind(s)}return o.destination={next:i?E(i):T,error:E(null!=n?n:I),complete:r?E(r):T},o}return n(t,e),t}(k);function E(e,t){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{e.apply(void 0,l([],s(t)))}catch(e){w(e)}}}function I(e){throw e}var P={closed:!0,next:T,error:I,complete:T},L="function"==typeof Symbol&&Symbol.observable||"@@observable";function A(e){return e}function D(e){return 0===e.length?A:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var M=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r,i=this,o=(r=e)&&r instanceof k||function(e){return e&&d(e.next)&&d(e.error)&&d(e.complete)}(r)&&b(r)?e:new x(e,t,n);return S((function(){var e=i,t=e.operator,n=e.source;o.add(t?t.call(o,n):n?i._subscribe(o):i._trySubscribe(o))})),o},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=_(t))((function(t,r){var i;i=n.subscribe((function(t){try{e(t)}catch(e){r(e),null==i||i.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[L]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return D(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=_(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function _(e){var t;return null!==(t=null!=e?e:C.Promise)&&void 0!==t?t:Promise}function B(e){return function(t){if(function(e){return d(null==e?void 0:e.lift)}(t))return t.lift((function(t){try{return e(t,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")}}var O=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.onFinalize=o,s._next=n?function(e){try{n(e)}catch(e){t.error(e)}}:e.prototype._next,s._error=i?function(e){try{i(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,s._complete=r?function(){try{r()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,s}return n(t,e),t.prototype.unsubscribe=function(){var t,n=this.closed;e.prototype.unsubscribe.call(this),!n&&(null===(t=this.onFinalize)||void 0===t||t.call(this))},t}(k),V=h((function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),N=function(e){function t(){var t=e.call(this)||this;return t.closed=!1,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return n(t,e),t.prototype.lift=function(e){var t=new $(this,this);return t.operator=e,t},t.prototype._throwIfClosed=function(){if(this.closed)throw new V},t.prototype.next=function(e){var t=this;S((function(){var n,r;if(t._throwIfClosed(),!t.isStopped){var i=t.observers.slice();try{for(var s=o(i),l=s.next();!l.done;l=s.next()){l.value.next(e)}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}}}))},t.prototype.error=function(e){var t=this;S((function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var n=t.observers;n.length;)n.shift().error(e)}}))},t.prototype.complete=function(){var e=this;S((function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}}))},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var t=this,n=t.hasError,r=t.isStopped,i=t.observers;return n||r?v:(i.push(e),new f((function(){return g(i,e)})))},t.prototype._checkFinalizedStatuses=function(e){var t=this,n=t.hasError,r=t.thrownError,i=t.isStopped;n?e.error(r):i&&e.complete()},t.prototype.asObservable=function(){var e=new M;return e.source=this,e},t.create=function(e,t){return new $(e,t)},t}(M),$=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return n(t,e),t.prototype.next=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===n||n.call(t,e)},t.prototype.error=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===n||n.call(t,e)},t.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},t.prototype._subscribe=function(e){var t,n;return null!==(n=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==n?n:v},t}(N),U=function(e){function t(t){var n=e.call(this)||this;return n._value=t,n}return n(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(t){var n=e.prototype._subscribe.call(this,t);return!n.closed&&t.next(this._value),n},t.prototype.getValue=function(){var e=this,t=e.hasError,n=e.thrownError,r=e._value;if(t)throw n;return this._throwIfClosed(),r},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(N),F=new M((function(e){return e.complete()}));function j(e,t){return new M((function(n){var r=0;return t.schedule((function(){r===e.length?n.complete():(n.next(e[r++]),n.closed||this.schedule())}))}))}var R=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function z(e){return d(null==e?void 0:e.then)}var H="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function Q(e,t){if(!e)throw new Error("Iterable cannot be null");return new M((function(n){var r=new f;return r.add(t.schedule((function(){var i=e[Symbol.asyncIterator]();r.add(t.schedule((function(){var e=this;i.next().then((function(t){t.done?n.complete():(n.next(t.value),e.schedule())}))})))}))),r}))}function W(e){return d(e[L])}function G(e){return d(null==e?void 0:e[H])}function q(e){return Symbol.asyncIterator&&d(null==e?void 0:e[Symbol.asyncIterator])}function Y(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Z(e){return c(this,arguments,(function(){var t,n,r;return i(this,(function(i){switch(i.label){case 0:t=e.getReader(),i.label=1;case 1:i.trys.push([1,,9,10]),i.label=2;case 2:return[4,a(t.read())];case 3:return n=i.sent(),r=n.value,n.done?[4,a(void 0)]:[3,5];case 4:return[2,i.sent()];case 5:return[4,a(r)];case 6:return[4,i.sent()];case 7:return i.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function J(e){return d(null==e?void 0:e.getReader)}function X(e,t){if(null!=e){if(W(e))return function(e,t){return new M((function(n){var r=new f;return r.add(t.schedule((function(){var i=e[L]();r.add(i.subscribe({next:function(e){r.add(t.schedule((function(){return n.next(e)})))},error:function(e){r.add(t.schedule((function(){return n.error(e)})))},complete:function(){r.add(t.schedule((function(){return n.complete()})))}}))}))),r}))}(e,t);if(R(e))return j(e,t);if(z(e))return function(e,t){return new M((function(n){return t.schedule((function(){return e.then((function(e){n.add(t.schedule((function(){n.next(e),n.add(t.schedule((function(){return n.complete()})))})))}),(function(e){n.add(t.schedule((function(){return n.error(e)})))}))}))}))}(e,t);if(q(e))return Q(e,t);if(G(e))return function(e,t){return new M((function(n){var r;return n.add(t.schedule((function(){r=e[H](),function(e,t,n,r){void 0===r&&(r=0);var i=t.schedule((function(){try{n.call(this)}catch(t){e.error(t)}}),r);e.add(i)}(n,t,(function(){var e=r.next(),t=e.value;e.done?n.complete():(n.next(t),this.schedule())}))}))),function(){return d(null==r?void 0:r.return)&&r.return()}}))}(e,t);if(J(e))return function(e,t){return Q(Z(e),t)}(e,t)}throw Y(e)}function K(e,t){return t?X(e,t):ee(e)}function ee(e){if(e instanceof M)return e;if(null!=e){if(W(e))return r=e,new M((function(e){var t=r[L]();if(d(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(R(e))return te(e);if(z(e))return n=e,new M((function(e){n.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,w)}));if(q(e))return ne(e);if(G(e))return t=e,new M((function(e){var n,r;try{for(var i=o(t),s=i.next();!s.done;s=i.next()){var l=s.value;if(e.next(l),e.closed)return}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}e.complete()}));if(J(e))return ne(Z(e))}var t,n,r;throw Y(e)}function te(e){return new M((function(t){for(var n=0;n<e.length&&!t.closed;n++)t.next(e[n]);t.complete()}))}function ne(e){return new M((function(t){(function(e,t){var n,o,s,l;return r(this,void 0,void 0,(function(){var r,a;return i(this,(function(i){switch(i.label){case 0:i.trys.push([0,5,6,11]),n=u(e),i.label=1;case 1:return[4,n.next()];case 2:if((o=i.sent()).done)return[3,4];if(r=o.value,t.next(r),t.closed)return[2];i.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=i.sent(),s={error:a},[3,11];case 6:return i.trys.push([6,,9,10]),o&&!o.done&&(l=n.return)?[4,l.call(n)]:[3,8];case 7:i.sent(),i.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))}))})(e,t).catch((function(e){return t.error(e)}))}))}function re(e,t){return t?j(e,t):te(e)}function ie(e){return e[e.length-1]}function oe(e){return d(ie(e))?e.pop():void 0}function se(e){return(t=ie(e))&&d(t.schedule)?e.pop():void 0;var t}function le(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=se(e);return n?j(e,n):re(e)}function ae(e,t){var n=d(e)?e:function(){return e},r=function(e){return e.error(n())};return new M(t?function(e){return t.schedule(r,0,e)}:r)}function ce(e,t){return B((function(n,r){var i=0;n.subscribe(new O(r,(function(n){r.next(e.call(t,n,i++))})))}))}var ue=Array.isArray;function de(e){return ce((function(t){return function(e,t){return ue(t)?e.apply(void 0,l([],s(t))):e(t)}(e,t)}))}var he,pe,ge,fe,ve,be,me,Ce=Array.isArray,ye=Object.getPrototypeOf,we=Object.prototype,Te=Object.keys;function Se(e){if(1===e.length){var t=e[0];if(Ce(t))return{args:t,keys:null};if((r=t)&&"object"==typeof r&&ye(r)===we){var n=Te(t);return{args:n.map((function(e){return t[e]})),keys:n}}}var r;return{args:e,keys:null}}function ke(e,t){return e.reduce((function(e,n,r){return e[n]=t[r],e}),{})}function xe(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=se(e),r=oe(e),i=Se(e),o=i.args,s=i.keys;if(0===o.length)return K([],n);var l=new M(Ee(o,n,s?function(e){return ke(s,e)}:A));return r?l.pipe(de(r)):l}function Ee(e,t,n){return void 0===n&&(n=A),function(r){Ie(t,(function(){for(var i=e.length,o=new Array(i),s=i,l=i,a=function(i){Ie(t,(function(){var a=K(e[i],t),c=!1;a.subscribe(new O(r,(function(e){o[i]=e,c||(c=!0,l--),l||r.next(n(o.slice()))}),(function(){--s||r.complete()})))}),r)},c=0;c<i;c++)a(c)}),r)}}function Ie(e,t,n){e?n.add(e.schedule(t)):t()}function Pe(e,t,n){return void 0===n&&(n=1/0),d(t)?Pe((function(n,r){return ce((function(e,i){return t(n,e,r,i)}))(ee(e(n,r)))}),n):("number"==typeof t&&(n=t),B((function(t,r){return function(e,t,n,r,i,o,s,l){var a=[],c=0,u=0,d=!1,h=function(){!d||a.length||c||t.complete()},p=function(e){return c<r?g(e):a.push(e)},g=function(e){o&&t.next(e),c++;var l=!1;ee(n(e,u++)).subscribe(new O(t,(function(e){null==i||i(e),o?p(e):t.next(e)}),(function(){l=!0}),void 0,(function(){if(l)try{c--;for(var e=function(){var e=a.shift();s?t.add(s.schedule((function(){return g(e)}))):g(e)};a.length&&c<r;)e();h()}catch(e){t.error(e)}})))};return e.subscribe(new O(t,p,(function(){d=!0,h()}))),function(){null==l||l()}}(t,r,e,n)})))}function Le(){return void 0===(e=1)&&(e=1/0),Pe(A,e);var e}function Ae(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=oe(e),r=Se(e),i=r.args,o=r.keys,s=new M((function(e){var t=i.length;if(t)for(var n=new Array(t),r=t,s=t,l=function(t){var l=!1;ee(i[t]).subscribe(new O(e,(function(e){l||(l=!0,s--),n[t]=e}),(function(){--r&&l||(s||e.next(o?ke(o,n):n),e.complete())})))},a=0;a<t;a++)l(a);else e.complete()}));return n?s.pipe(de(n)):s}function De(e,t,n){return r=function(){return e()?t:n},new M((function(e){ee(r()).subscribe(e)}));var r}function Me(e,t){return B((function(n,r){var i=0;n.subscribe(new O(r,(function(n){return e.call(t,n,i++)&&r.next(n)})))}))}function _e(e){return B((function(t,n){var r,i=null,o=!1;i=t.subscribe(new O(n,void 0,void 0,(function(s){r=ee(e(s,_e(e)(t))),i?(i.unsubscribe(),i=null,r.subscribe(n)):o=!0}))),o&&(i.unsubscribe(),i=null,r.subscribe(n))}))}function Be(e,t){return d(t)?Pe(e,t,1):Pe(e,1)}function Oe(e){return e<=0?function(){return F}:B((function(t,n){var r=0;t.subscribe(new O(n,(function(t){++r<=e&&(n.next(t),e<=r&&n.complete())})))}))}function Ve(e){return B((function(t,n){try{t.subscribe(n)}finally{n.add(e)}}))}function Ne(e,t){return B((function(n,r){var i=null,o=0,s=!1,l=function(){return s&&!i&&r.complete()};n.subscribe(new O(r,(function(n){null==i||i.unsubscribe();var s=0,a=o++;ee(e(n,a)).subscribe(i=new O(r,(function(e){return r.next(t?t(n,e,a,s++):e)}),(function(){i=null,l()})))}),(function(){s=!0,l()})))}))}function $e(e){return B((function(t,n){ee(e).subscribe(new O(n,(function(){return n.complete()}),T)),!n.closed&&t.subscribe(n)}))}function Ue(e,t,n){var r=d(e)||t||n?{next:e,error:t,complete:n}:e;return r?B((function(e,t){var n;null===(n=r.subscribe)||void 0===n||n.call(r);var i=!0;e.subscribe(new O(t,(function(e){var n;null===(n=r.next)||void 0===n||n.call(r,e),t.next(e)}),(function(){var e;i=!1,null===(e=r.complete)||void 0===e||e.call(r),t.complete()}),(function(e){var n;i=!1,null===(n=r.error)||void 0===n||n.call(r,e),t.error(e)}),(function(){var e,t;i&&(null===(e=r.unsubscribe)||void 0===e||e.call(r)),null===(t=r.finalize)||void 0===t||t.call(r)})))})):A}!function(e){e.NoToken="NoToken",e.Unauthorized="Unauthorized",e.RateLimit="RateLimit",e.Unknown="Unknown",e.Abort="Abort"}(he||(he={})),function(e){e.Left="left",e.Right="right"}(pe||(pe={})),function(e){e.Comment="commentCard"}(ge||(ge={})),function(e){e.Complete="complete",e.Incomplete="incomplete"}(fe||(fe={})),function(e){e.Green="green",e.Yellow="yellow",e.Orange="orange",e.Red="red",e.Purple="purple",e.Blue="blue",e.Sky="sky",e.Lime="lime",e.Pink="pink",e.Black="black"}(ve||(ve={})),function(e){e.Top="top",e.Bottom="bottom"}(be||(be={})),function(e){e[e.Info=0]="Info",e[e.Warn=1]="Warn",e[e.Error=2]="Error"}(me||(me={}));const Fe={id:"trello-plugin-icon-trello",svgContent:'<g><path fill="currentColor" stroke="currentColor" style="stroke:none;fill-rule:nonzero;fill-opacity:1;" d="M 82 8 L 18 8 C 12.480469 8 8 12.480469 8 18 L 8 82 C 8 87.519531 12.480469 92 18 92 L 82 92 C 87.519531 92 92 87.519531 92 82 L 92 18 C 92 12.480469 87.519531 8 82 8 Z M 42 72 C 42 74.199219 40.199219 76 38 76 L 24 76 C 21.800781 76 20 74.199219 20 72 L 20 24 C 20 21.800781 21.800781 20 24 20 L 38 20 C 40.199219 20 42 21.800781 42 24 Z M 80 48 C 80 50.199219 78.199219 52 76 52 L 62 52 C 59.800781 52 58 50.199219 58 48 L 58 24 C 58 21.800781 59.800781 20 62 20 L 76 20 C 78.199219 20 80 21.800781 80 24 Z M 80 48 "/></g>'},je="https://api.trello.com",Re="The Trello plugin requires an API token for use. Please visit plugin settings.",ze="The Trello API is rate limited. Please try again later.",He="The Trello API rejected your token. Please create a new token.",Qe="The Trello API could not be reached. Please create a new token or try again later.",We={token:"",customUi:{global:{checklists:!0,comments:!0,description:!0,labels:!0,list:!0,title:!0}},selectedBoards:[],openToSide:pe.Right,newCardPosition:be.Top,movedCardPosition:be.Top,verboseLogging:!1},Ge={settings:We,version:"1.6.0",firstRun:!0,connectedCards:{}};var qe;!function(e){e.BoardCard="trello_board_card_id",e.TrelloId="trello_plugin_note_id"}(qe||(qe={}));const Ye={name:"Create a new card...",id:"CREATE_NEW_TRELLO_CARD"};class Ze extends e.Modal{constructor(e,t){super(e),this.plugin=t,this.selectedBoards=this.plugin.state.settings.pipe(Oe(1),ce((e=>e.selectedBoards?e.selectedBoards:[]))),this.newState={}}onOpen(){this.contentEl.empty(),Ae({selected:this.selectedBoards,boards:this.plugin.api.getBoards()}).subscribe({next:({selected:e,boards:t})=>{const n=this.contentEl.createDiv("trello-board-select--container");n.createEl("h2",{text:"Boards",cls:"trello-board-select--title"}),this.newState={},e.forEach((e=>{this.newState[e.id]=e})),t.forEach((e=>{this.buildToggle(e,n)}));const r=this.contentEl.createDiv("trello-board-select--controls");r.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",(()=>{this.onSave()}));r.createEl("button",{text:"Cancel"}).addEventListener("click",(()=>{this.close()}))},error:()=>{if(this.plugin.state.currentToken.value&&""!==this.plugin.state.currentToken.value)new e.Notice(Qe),this.close();else{this.contentEl.createDiv({cls:"trello-board-select--empty-state",text:"An API token is required."}).createEl("button",{text:"Setup Trello"}).addEventListener("click",(()=>{this.plugin.openTrelloSettings(),this.close()}))}}})}onClose(){this.contentEl.empty()}buildToggle(e,t){const n=t.createDiv("trello-board-select--toggle-container");n.createDiv({text:e.name,cls:"trello-board-select--toggle-label"});const r=n.createDiv({cls:"trello-board-select--toggle checkbox-container"});this.newState[e.id]&&r.addClass("is-enabled"),n.addEventListener("click",(()=>{this.newState[e.id]?(r.removeClass("is-enabled"),delete this.newState[e.id]):(r.addClass("is-enabled"),this.newState[e.id]=e)}))}onSave(){const e=Object.values(this.newState);this.plugin.state.updateSetting("selectedBoards",e),this.close()}}class Je extends e.SuggestModal{constructor(e){super(e),this.selected=new N,this.options=[],this.selectionMade=!1}onOpen(){this.selectionMade=!1,super.onOpen()}onClose(){this.selectionMade||(this.selected.error(he.Abort),this.selected.complete(),this.selected=new N),super.onClose()}selectSuggestion(e,t){this.selectionMade=!0,super.selectSuggestion(e,t)}onChooseSuggestion(e){this.selected.next(e),this.selected.complete(),this.selected=new N}}class Xe extends Je{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello board"}])}getSuggestions(e){const t=e.toLowerCase();return this.options.filter((e=>e.name.toLowerCase().includes(t)))}renderSuggestion(e,t){t.setText(e.name)}}class Ke{constructor(e,t=!0){this.parent=e,this.openOne=t,this.sections=[]}addSection(t){const n=this.parent.createDiv("trello-accordion--container"),r=n.createDiv("trello-accordion--title");r.createSpan({text:t,cls:"trello-accordion--title-text"});const i=r.createSpan("trello-accordion--title-icon");e.setIcon(i,"left-chevron-glyph");const o=n.createDiv("trello-accordion--content"),s={containerEl:n,titleEl:r,titleIcon:i,contentEl:o,expanded:!1};return s.titleEl.addEventListener("click",(()=>{s.expanded?this.collapseSection(s):this.expandSection(s)})),this.sections.push(s),s}expandSection(e){this.openOne&&this.sections.forEach((t=>{t!==e&&this.collapseSection(t)})),e.expanded=!0,e.titleIcon.addClass("trello-accordion--expanded"),e.contentEl.style.maxHeight=e.contentEl.scrollHeight+"px"}collapseSection(e){e.expanded=!1,e.titleIcon.removeClass("trello-accordion--expanded"),e.contentEl.style.maxHeight=""}}class et extends e.Modal{constructor(e,t){super(e),this.plugin=t,this.labels=[],this.createdCard=new N,this.selectedLabels={},this.finishedCardCreation=!1}onOpen(){this.contentEl.empty();const e=this.contentEl.createDiv();this.title=this.renderTitle(e);const t=new Ke(e),n=t.addSection("Description"),r=t.addSection("Labels");this.description=this.renderDescription(n.contentEl),this.renderLabels(r.contentEl),this.position=this.renderPositionSelect(e);const i=e.createDiv("trello-card-create--controls");i.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",this.onSave.bind(this));i.createEl("button",{text:"Cancel"}).addEventListener("click",this.close.bind(this))}onClose(){this.finishedCardCreation||this.createdCard.error(he.Abort),this.reset()}onSave(){this.plugin.api.addNewCard({idList:this.list.id,idLabels:Object.values(this.selectedLabels).map((e=>e.id)),name:this.title.value,desc:this.description.value,pos:this.position.value}).pipe(ce((e=>e.response))).subscribe({next:e=>{this.finishedCardCreation=!0,this.createdCard.next(e),this.close()},error:e=>{this.finishedCardCreation=!0,this.createdCard.error(e)}})}reset(){this.selectedLabels={},this.createdCard=new N,this.title.value="",this.description.value="",this.finishedCardCreation=!1}renderTitle(e){return e.createEl("input",{cls:"trello-card-create--title",attr:{placeholder:"Enter a title for this card..."}})}renderDescription(e){return e.createDiv("trello-card-create--desc-wrapper").createDiv({cls:"trello-card-create--desc-container"}).createEl("textarea",{cls:"trello-card-create--desc",attr:{onInput:"this.parentNode.dataset.replicatedValue = this.value",placeholder:"Add a more detailed description..."}})}renderLabels(e){const t=e.createDiv("trello-card-create--labels");this.labels.forEach((e=>{this.renderLabel(e,t)}))}renderLabel(e,t){const n=t.createDiv("trello-card-create--label-container");e.color?n.addClass(`label-color--${e.color}`):n.addClass("label-color--grey"),n.createSpan({text:e.name,cls:"trello-card-create--label-name"}),this.buildCheck(e,n)}buildCheck(t,n){const r=n.createSpan({cls:"trello-card-create--check"});n.addEventListener("click",(()=>{this.selectedLabels[t.id]?(r.empty(),delete this.selectedLabels[t.id]):(e.setIcon(r,"checkbox-glyph"),this.selectedLabels[t.id]=t)}))}renderPositionSelect(e){const t=e.createDiv("trello-card-create--position-select-container");t.createEl("label",{text:"Add new card to",attr:{for:"trello-card-create--position-select"}});const n=t.createEl("select",{cls:"dropdown",attr:{id:"trello-card-create--position-select"}});return n.createEl("option",{text:"Top",attr:{value:be.Top}}),n.createEl("option",{text:"Bottom",attr:{value:be.Bottom}}),n.value=this.defaultPosition,n}}class tt extends Je{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello card"}])}getSuggestions(e){const t=e.toLowerCase();return[Ye,...this.options.filter((e=>e.name.toLowerCase().includes(t)))]}renderSuggestion(e,t){t.setText(e.name)}}class nt extends e.Modal{constructor(t,n){super(t),this.plugin=n,this.source=new U(null),xe({customUi:this.plugin.state.settings.pipe($e(this.plugin.destroy),ce((e=>e.customUi))),source:this.source.pipe(Me((e=>null!==e)),$e(this.plugin.destroy))}).pipe(ce((({customUi:e,source:t})=>e[t]?(this.plugin.log("CustomizeUIModal",`Customizing ui config for trello ID ${t}`),e[t]):(this.plugin.log("CustomizeUIModal","Customizing global UI config"),e.global)))).subscribe((t=>{this.plugin.log("CustomizeUIModal","Building Customize UI modal");const n=this.source.value;this.contentEl.empty(),this.newState=Object.assign({},t),new e.Setting(this.contentEl).setName("Title").addToggle((e=>{e.setValue(t.title).onChange((e=>this.newState.title=e))})),new e.Setting(this.contentEl).setName("Description").addToggle((e=>{e.setValue(t.description).onChange((e=>this.newState.description=e))})),new e.Setting(this.contentEl).setName("List").addToggle((e=>{e.setValue(t.list).onChange((e=>this.newState.list=e))})),new e.Setting(this.contentEl).setName("Comments").addToggle((e=>{e.setValue(t.comments).onChange((e=>this.newState.comments=e))})),new e.Setting(this.contentEl).setName("Labels").addToggle((e=>{e.setValue(t.labels).onChange((e=>this.newState.labels=e))})),new e.Setting(this.contentEl).setName("Checklists").addToggle((e=>{e.setValue(t.checklists).onChange((e=>this.newState.checklists=e))}));const r=this.contentEl.createDiv();if("global"!==n){r.createEl("button",{text:"Reset to Default"}).addEventListener("click",(()=>{this.plugin.log("CustomizeUIModal",`Resetting UI config for trello ID ${n}`),this.plugin.state.updateCustomUI(n,null),this.plugin.view.updateCard(),this.close()}))}r.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",(()=>{this.plugin.log("CustomizeUIModal",`Saving UI config for trello ID ${n}`),this.plugin.state.updateCustomUI(n,this.newState),this.close()}))}))}}class rt extends Je{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello list"}])}getSuggestions(e){const t=e.toLowerCase();return this.options.filter((e=>e.name.toLowerCase().includes(t)))}renderSuggestion(e,t){t.setText(e.name)}}class it{constructor(e,t){this.plugin=e,this.cardCache={},this.cardActionsCache={},this.listCache={},this.labelCache={},this.checklistCache={},this.boardCardId=new U(null),this.connectedCardId=new U(null),this.currentToken=new U(""),this.verboseLogging=new U(!1),this.data=new U(t),this.data.pipe($e(e.destroy)).subscribe((e=>r(this,void 0,void 0,(function*(){yield this.plugin.saveData(e)}))))}get settings(){return this.data.pipe(ce((e=>e.settings)))}get connectedCards(){return this.data.value.connectedCards}updateSetting(e,t){const n=Object.assign({},this.data.value.settings);n[e]=t,this.data.next(Object.assign(Object.assign({},this.data.value),{settings:n}))}updateConnectedCard(e,t){const n=Object.assign({},this.data.value.connectedCards);t?n[e]=t:delete n[e],this.data.next(Object.assign(Object.assign({},this.data.value),{connectedCards:n}))}updateCustomUI(e,t){const n=Object.assign({},this.data.value.settings.customUi);t?n[e]=t:delete n[e],this.updateSetting("customUi",n)}completedFirstRun(){this.data.next(Object.assign(Object.assign({},this.data.value),{firstRun:!1}))}updateVersion(){this.data.next(Object.assign(Object.assign({},this.data.value),{version:Ge.version}))}}var ot=h((function(e){return function(e,t,n){var r;this.message=e,this.name="AjaxError",this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType;try{r=function(e){switch(e.responseType){case"json":if("response"in e)return e.response;var t=e;return JSON.parse(t.responseText);case"document":return e.responseXML;case"text":default:return"response"in e?e.response:(t=e).responseText}}(t)}catch(e){r=t.responseText}this.response=r}}));function st(t){var n;return K(e.requestUrl({url:t.url,method:null!==(n=t.method)&&void 0!==n?n:"GET"})).pipe(ce((e=>{return{status:(t=e).status,responseHeaders:t.headers,response:t.json};var t})))}!function(){function e(e,t){return ot.call(this,"ajax timeout",e,t),this.name="AjaxTimeoutError",this}e.prototype=Object.create(ot.prototype)}();class lt{constructor(e){this.plugin=e,this.token=new U(""),this.plugin.state.settings.pipe($e(this.plugin.destroy),ce((e=>e.token))).subscribe(this.token)}getBoards(){if(this.plugin.log("TrelloAPI.getBoards",""),""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/members/me/boards?fields=name,url`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)))}getCardFromBoard(e,t,n=!1,r=12e4){this.plugin.log("TrelloAPI.getCardFromBoard","");const i=this.plugin.state.cardCache[t];return!i||n||(new Date).getTime()-i.timestamp.getTime()>r?this._getCardFromBoard(e,t):(this.plugin.log("TrelloAPI.getCardFromBoard","-> Returning cached value."),le(i.item))}_getCardFromBoard(e,t){if(""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/boards/${e}/cards/${t}`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)),Ue((e=>{e&&(this.plugin.state.cardCache[e.id]={item:e,timestamp:new Date})})))}getLabelsFromBoard(e,t=!1,n=6e5){this.plugin.log("TrelloAPI.getLabelsFromBoard","");const r=this.plugin.state.labelCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getLabelsFromBoard(e):(this.plugin.log("TrelloAPI.getLabelsFromBoard","-> Returning cached value."),le(r.item))}_getLabelsFromBoard(e){if(""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/boards/${e}/labels`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)),Ue((t=>{this.plugin.state.labelCache[e]={item:t,timestamp:new Date}})))}getListsFromBoard(e){if(this.plugin.log("TrelloAPI.getListsFromBoard",""),""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/boards/${e}/lists`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)),Ue((e=>{e&&e.length>0&&e.forEach((e=>{this.plugin.state.listCache[e.id]={item:e,timestamp:new Date}}))})))}getList(e,t=!1,n=6e5){this.plugin.log("TrelloAPI.getList","");const r=this.plugin.state.listCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getList(e):(this.plugin.log("TrelloAPI.getList","-> Returning cached value."),le(r.item))}_getList(e){if(""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/lists/${e}`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)),Ue((e=>{e&&(this.plugin.state.listCache[e.id]={item:e,timestamp:new Date})})))}getCardsFromBoard(e){if(this.plugin.log("TrelloAPI.getCardsFromBoard",""),""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/boards/${e}/cards`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)),Ue((e=>{e.forEach((e=>{this.plugin.state.cardCache[e.id]={item:e,timestamp:new Date}}))})))}getActionsFromCard(e,t=[ge.Comment],n=!1,r=6e4){this.plugin.log("TrelloAPI.getActionsFromCard","");const i=this.plugin.state.cardActionsCache[e];return!i||n||(new Date).getTime()-i.timestamp.getTime()>r?this._getActionsFromCard(e,t):(this.plugin.log("TrelloAPI.getActionsFromCard","-> Returning cached value."),le(i.item))}_getActionsFromCard(e,t=[ge.Comment]){if(""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/cards/${e}/actions?filter=${t.join(",")}`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)),Ue((t=>{t&&(this.plugin.state.cardActionsCache[e]={item:t,timestamp:new Date})})))}getChecklistsFromCard(e,t=[],n=!1,r=6e4){this.plugin.log("TrelloAPI.getChecklistsFromCard","");const i=t.map((e=>this.plugin.state.checklistCache[e])),o=(new Date).getTime();return!i||n||i.some((e=>void 0===e||o-e.timestamp.getTime()>r))?this._getChecklistsFromCard(e):(this.plugin.log("TrelloAPI.getChecklistsFromCard","-> Returning cached value."),le(i.map((e=>e.item))))}_getChecklistsFromCard(e){if(""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/cards/${e}/checklists`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)),Ue((e=>{if(e&&e.length>0){const t=new Date;e.forEach((e=>{this.plugin.state.checklistCache[e.id]={item:e,timestamp:t}}))}})))}getChecklist(e,t=!1,n=6e4){this.plugin.log("TrelloAPI.getChecklist","");const r=this.plugin.state.checklistCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getChecklist(e):(this.plugin.log("TrelloAPI.getChecklist","-> Returning cached value."),le(r.item))}_getChecklist(e){if(""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/checklists/${e}`)}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)),Ue((t=>{t&&(this.plugin.state.checklistCache[e]={item:t,timestamp:new Date})})))}addCommentToCard(e,t){if(this.plugin.log("TrelloAPI.addCommentToCard",""),""===this.token.value)return ae((()=>he.NoToken));return st({url:this.auth(`${je}/1/cards/${e}/actions/comments?text=${encodeURIComponent(t)}`),method:"POST"}).pipe(_e((e=>this.handleAPIError(e))))}addNewCard(e){if(this.plugin.log("TrelloAPI.addNewCard",""),""===this.token.value)return ae((()=>he.NoToken));let t=this.auth(`${je}/1/cards`);return t=this.addQueryParam(t,"idList",e.idList),t=this.addQueryParam(t,"name",e.name,!0),t=this.addQueryParam(t,"desc",e.desc,!0),t=this.addQueryParam(t,"pos",e.pos),t=this.addQueryParam(t,"idLabels",e.idLabels?e.idLabels.join(","):void 0),st({url:t,method:"POST"}).pipe(_e((e=>this.handleAPIError(e))))}updateCardList(e,t,n=be.Top){return this.plugin.log("TrelloAPI.updateCardList",""),this.updateCard({id:e,idList:t,pos:n})}updateCheckItemState(e,t,n){return this.plugin.log("TrelloAPI.updateCheckItemState",""),this.updateCheckItem(e,{id:t,state:n})}updateCard(e){if(this.plugin.log("TrelloAPI.updateCard",""),""===this.token.value)return ae((()=>he.NoToken));let t=this.auth(`${je}/1/cards/${e.id}`);return t=this.addQueryParam(t,"name",e.name,!0),t=this.addQueryParam(t,"desc",e.desc,!0),t=this.addQueryParam(t,"idBoard",e.idBoard),t=this.addQueryParam(t,"idList",e.idList),t=this.addQueryParam(t,"due",e.due),t=this.addQueryParam(t,"idAttachmentCover",e.idAttachmentCover),e.idLabels&&(t=this.addQueryParam(t,"idLabels",e.idLabels.join(","))),void 0!==e.dueComplete&&(t=this.addQueryParam(t,"dueComplete",e.dueComplete.toString())),st({url:t,method:"PUT"}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)))}updateCheckItem(e,t){if(this.plugin.log("TrelloAPI.updateCheckItem",""),""===this.token.value)return ae((()=>he.NoToken));let n=this.auth(`${je}/1/cards/${e}/checkItem/${t.id}`);return n=this.addQueryParam(n,"name",t.name,!0),n=this.addQueryParam(n,"state",t.state,!0),n=this.addQueryParam(n,"idChecklist",t.idChecklist),st({url:n,method:"PUT"}).pipe(_e((e=>this.handleAPIError(e))),ce((e=>e.response)))}auth(e){return`${e}${e.includes("?")?"&":"?"}key=9537467993aefd6dca9ee7788179c298&token=${this.token.value}`}addQueryParam(e,t,n,r=!1){return n?`${e}${e.includes("?")?"&":"?"}${t}=${r?encodeURIComponent(n):n}`:e}handleAPIError(e){return ae((()=>{if(!(e instanceof ot))return he.Unknown;switch(e.status){case 401:return he.Unauthorized;case 429:return he.RateLimit;default:return he.Unknown}}))}}class at extends e.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t,this.boardSelectModal=new Ze(this.plugin.app,this.plugin)}display(){return r(this,void 0,void 0,(function*(){this.plugin.log("TrelloSettings.display","Initializing settings"),this.containerEl.empty(),this.containerEl.createEl("h2",{text:"Obsidian Trello settings."}),this.plugin.state.settings.pipe(Oe(1)).subscribe((e=>{this.buildTokenSetting(this.containerEl,e),this.buildUiConfigSetting(this.containerEl),this.buildBoardSelectSetting(this.containerEl),this.buildOpenToSideSetting(this.containerEl,e),this.buildNewCardPositionSetting(this.containerEl,e),this.buildMovedCardPositionSetting(this.containerEl,e),this.buildVerboseLoggingSetting(this.containerEl,e)}))}))}buildTokenSetting(t,n){return r(this,void 0,void 0,(function*(){this.plugin.log("TrelloSettings.buildTokenSetting",`-> Adding token setting with initial value ${n.token}`);const r=new DocumentFragment;r.createDiv({cls:"setting-item-description"}).innerHTML='Your API token. <a href="https://trello.com/1/authorize?expiration=never&scope=read,write&response_type=token&name=Obsidian%20Trello%20Token&key=9537467993aefd6dca9ee7788179c298">Generate one</a> then copy it here. This token can be revoked at any time in your Trello account settings.',new e.Setting(t).setName("Trello Token").setDesc(r).addText((e=>{e.setPlaceholder("Enter token").setValue(n.token).onChange((e=>{this.plugin.state.updateSetting("token",e.trim()),this.plugin.view.updateCard()}))}))}))}buildUiConfigSetting(t){this.plugin.log("TrelloSettings.buildConfigSetting","-> Adding UI config setting"),new e.Setting(t).setName("Customize UI").setDesc("Configure which parts of connected trello cards are displayed by default. Can be overridden per note.").addButton((e=>{e.setButtonText("Configure").onClick((()=>{this.plugin.customizeUIModal.source.next("global"),this.plugin.customizeUIModal.open()}))}))}buildBoardSelectSetting(t){this.plugin.log("TrelloSettings.buildBoardSelectSetting","-> Adding board select setting"),new e.Setting(t).setName("Select Boards").setDesc("These boards will be available to select cards from.").addButton((e=>{e.setButtonText("Select").onClick((()=>{this.boardSelectModal.open()}))}))}buildOpenToSideSetting(t,n){this.plugin.log("TrelloSettings.buildOpenToSideSetting",`-> Adding open to side setting with initial value ${n.openToSide}`),new e.Setting(t).setName("Open to Side").setDesc("Whether the Trello pane should open to the left or right side.").addDropdown((e=>{e.addOption(pe.Right,"Right").addOption(pe.Left,"Left").setValue(n.openToSide).onChange((e=>{this.plugin.state.updateSetting("openToSide",e)}))}))}buildNewCardPositionSetting(t,n){this.plugin.log("TrelloSettings.buildNewCardPositionSetting",`-> Adding new card position setting with initial value ${n.newCardPosition}`),new e.Setting(t).setName("New Card Position").setDesc("Whether newly created cards should be added to the top or bottom of the list by default. Can be overridden when adding a card.").addDropdown((e=>{e.addOption(be.Top,"Top").addOption(be.Bottom,"Bottom").setValue(n.newCardPosition).onChange((e=>{this.plugin.state.updateSetting("newCardPosition",e)}))}))}buildMovedCardPositionSetting(t,n){this.plugin.log("TrelloSettings.buildMovedCardPositionSetting",`-> Adding moved card position setting with initial value ${n.movedCardPosition}`),new e.Setting(t).setName("Moved Card Position").setDesc("When moving a card from one list to another, should it be moved to the top or bottom of the selected list.").addDropdown((e=>{e.addOption(be.Top,"Top").addOption(be.Bottom,"Bottom").setValue(n.movedCardPosition).onChange((e=>{this.plugin.state.updateSetting("movedCardPosition",e)}))}))}buildVerboseLoggingSetting(t,n){this.plugin.log("TrelloSettings.buildVerboseLoggingSetting",`-> Adding verbose logging setting with initial value ${n.verboseLogging}`),new e.Setting(t).setName("Verbose Logging").setDesc("Enable this if you're having trouble with the plugin. Logs will be enabled in the console.").addToggle((e=>{e.setValue(n.verboseLogging).onChange((e=>{this.plugin.state.updateSetting("verboseLogging",e)}))}))}}class ct{constructor(e,t,n){this.plugin=e,this.destroy=t,this.update=n,this.bypassActionCache=!1,this.bypassListCache=!1,this.bypassChecklistsCache=!1,this.cardError=null,this.actionsError=null,this.listError=null,this.checklistsError=null,this.connectedId=new U(null),this.currentCard=new U(null),this.currentActions=new U(null),this.currentList=new U(null),this.currentChecklists=new U(null),this.currentUIConfig=new U(null),this.plugin.state.boardCardId.pipe($e(this.destroy),Ue((e=>{e||(this.cardError=null,this.actionsError=null,this.listError=null,this.currentCard.next(null),this.currentActions.next(null),this.currentList.next(null))})),Me((e=>null!==e&&""!==e)),Ne((e=>{const[t,n]=e.split(";");return this.plugin.log("TrelloViewManager",`-> Got new board/card ID ${t}/${n}`),this.plugin.log("TrelloViewManager","-> Getting card from API/cache."),this.plugin.api.getCardFromBoard(t,n)}))).subscribe({next:e=>{null!==this.currentCard.value&&this.currentCard.value.id!==e.id&&(this.plugin.log("TrelloViewManager","Card changed, resetting extra info."),this.currentActions.next(null),this.currentList.next(null)),this.cardError=null,this.plugin.log("TrelloViewManager","-> Card updated."),this.currentCard.next(e)},error:e=>{this.cardError=e,this.currentCard.next(null)}}),this.plugin.state.connectedCardId.pipe($e(this.destroy),Ue((e=>{e||(this.connectedId.next(null),this.currentUIConfig.next(null))})),Me((e=>null!==e&&""!==e)),Ue((e=>{this.connectedId.next(e)})),Pe((e=>xe([le(e),this.plugin.state.settings.pipe(ce((e=>e.customUi)))])))).subscribe((([e,t])=>{const n=t[e]?t[e]:t.global;this.currentUIConfig.next(n),this.plugin.log("TrelloViewManager",`Connected card with ${e}`)})),this.currentCard.pipe($e(this.destroy),Me((e=>null!==e)),Ne((e=>this.plugin.api.getActionsFromCard(e.id,void 0,this.bypassActionCache))),Ve((()=>{this.bypassActionCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","Actions updated."),this.actionsError=null,this.currentActions.next(e)},error:e=>{this.actionsError=e,this.currentActions.next(null)}}),this.currentCard.pipe($e(this.destroy),Me((e=>null!==e)),Ne((e=>this.plugin.api.getList(e.idList,this.bypassListCache))),Ve((()=>{this.bypassListCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","List updated."),this.listError=null,this.currentList.next(e)},error:e=>{this.listError=e,this.currentList.next(null)}}),this.currentCard.pipe($e(this.destroy),Me((e=>null!==e&&null!==e.idChecklists&&e.idChecklists.length>0)),Ne((e=>this.plugin.api.getChecklistsFromCard(e.id,e.idChecklists,this.bypassChecklistsCache))),ce((e=>(e.sort(((e,t)=>e.pos<t.pos?-1:1)),e.forEach((e=>{e.checkItems.sort(((e,t)=>e.pos<t.pos?-1:1))})),e))),Ve((()=>{this.bypassChecklistsCache=!1}))).subscribe({next:e=>{this.plugin.log("TrelloViewManager","Checklist updated."),this.checklistsError=null,this.currentChecklists.next(e)},error:e=>{this.checklistsError=e,this.currentChecklists.next(null)}}),this.update.pipe($e(this.destroy),Me((()=>null!==this.currentCard.value)),Ue((()=>{this.plugin.log("TrelloViewManager","Refreshing data."),this.bypassActionCache=!0,this.bypassListCache=!0,this.bypassChecklistsCache=!0})),Ne((()=>{const e=this.currentCard.value;return this.plugin.api.getCardFromBoard(e.idBoard,e.id,!0)}))).subscribe({next:e=>{this.cardError=null,e&&(this.plugin.log("TrelloViewManager","-> Got updated card."),this.currentCard.next(e))},error:e=>{this.cardError=e,this.currentCard.next(null)}})}moveCard(){if(this.currentCard.value&&this.currentList.value){this.plugin.log("TrelloViewManager.moveCard","Beginning move card flow");const e=this.currentCard.value,t=this.currentList.value;Ae({list:this.plugin.api.getListsFromBoard(e.idBoard).pipe(ce((e=>{this.plugin.log("TrelloViewManager.moveCard","-> Marking current list.");const n=e.find((e=>e.id===t.id));return n&&(n.name=`${n.name} (current list)`),e})),Be((e=>(this.plugin.log("TrelloViewManager.moveCard","-> Got all lists for board."),this.plugin.listSuggestModal.options=e,this.plugin.listSuggestModal.open(),this.plugin.listSuggestModal.selected))),Oe(1),Ue((e=>{this.plugin.log("TrelloViewManager.moveCard",`-> Selected list ${e.id}. Updating card.`)}))),position:this.plugin.state.settings.pipe(Oe(1),ce((e=>e.movedCardPosition)),Ue((e=>{this.plugin.log("TrelloViewManager.moveCard",`-> Moved card position: ${e}`)})))}).pipe(Be((({list:t,position:n})=>this.plugin.api.updateCardList(e.id,t.id,n)))).subscribe({next:e=>{this.plugin.log("TrelloViewManager.moveCard","-> Updated card."),this.currentCard.next(e)},error:e=>{he.Abort}})}}}class ut extends e.ItemView{constructor(e,t){super(t),this.plugin=e,this.destroy=new N,this.update=new N,this.viewManager=new ct(this.plugin,this.destroy,this.update),xe([this.viewManager.currentCard,this.viewManager.currentActions,this.viewManager.currentList,this.viewManager.currentChecklists,this.viewManager.currentUIConfig]).pipe($e(this.destroy)).subscribe((([e,t,n,r,i])=>{this.contentEl.empty();const o=[this.viewManager.cardError,this.viewManager.actionsError,this.viewManager.listError];o.some((e=>null!==e))?this.renderEmptyView(this.getWorstError(o)):null===e?this.renderEmptyView(null):this.renderConnectedView(e,t,n,r,i)}))}getDisplayText(){return"Trello"}getViewType(){return"trello-plugin"}getIcon(){return Fe.id}onunload(){this.destroy.next(),this.destroy.complete()}updateCard(){this.update.next()}renderPaneContainer(){return this.contentEl.createDiv("trello-pane--container")}renderEmptyView(e){this.plugin.log("TrelloView.renderEmptyView","");const t=this.renderPaneContainer();if(null===e||e===he.NoToken)if(t.createEl("h2",{text:"No Trello card connected."}),e===he.NoToken){t.createDiv({text:"An API token is required."});t.createEl("button",{text:"Setup Trello",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.openTrelloSettings()}))}else{t.createEl("button",{text:"Connect Trello Card",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.connectTrelloCard()}))}else if(t.createEl("h2",{text:"Could not reach Trello API."}),e===he.RateLimit)t.createDiv({text:ze});else if(e===he.Unauthorized){t.createDiv({text:He});t.createEl("button",{text:"Setup Trello",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.openTrelloSettings()}))}else t.createDiv({text:Qe})}renderConnectedView(e,t,n,r,i){this.plugin.log("TrelloView.renderConnectedView",""),this.renderHeader(this.contentEl);const o=this.renderPaneContainer();if((null==i?void 0:i.list)||(null==i?void 0:i.title)||(null==i?void 0:i.description)){const t=o.createDiv("trello-pane--card-info");(null==i?void 0:i.list)&&n&&this.renderCardList(n,t),i.title&&this.renderCardTitle(e,t),i.description&&e.desc&&this.renderCardDesc(e,t)}if((null==i?void 0:i.labels)&&e.labels&&e.labels.length>0){const t=o.createDiv("trello-pane--label-section");this.renderLabels(e,t)}if(null==i?void 0:i.comments){const n=o.createDiv("trello-pane--comment-section");this.renderCommentSection(e,t,n)}if((null==i?void 0:i.checklists)&&r&&r.length>0){const t=o.createDiv("trello-pane--checklist-section");this.renderChecklistSection(e.id,r,t)}}renderHeader(e){this.plugin.log("TrelloView.renderHeader","");const t=e.createDiv("nav-header").createDiv("nav-buttons-container");this.renderNavButton(t,"Refresh card","reset",(()=>{this.update.next()})),this.renderNavButton(t,"Link another card","link",(()=>{this.plugin.connectTrelloCard()})),this.renderNavButton(t,"Unlink card","trash",(()=>{this.plugin.disconnectTrelloCard()})),this.renderNavButton(t,"Customize UI","gear",(()=>{this.plugin.customizeUIModal.source.next(this.viewManager.connectedId.value),this.plugin.customizeUIModal.open()}))}renderCardList(t,n){this.plugin.log("TrelloView.renderCardList","");const r=n.createEl("a",{cls:"trello-pane--card-info--list",text:t.name,attr:{"aria-label":"Move card",href:"#"}}),i=r.createSpan();e.setIcon(i,"right-arrow-with-tail"),r.addEventListener("click",(()=>{this.viewManager.moveCard()}))}renderCardTitle(t,n){this.plugin.log("TrelloView.renderCardTitle","");const r=n.createEl("h3",{text:t.name}).createEl("a",{attr:{href:t.url,"aria-label":"View on Trello"}});e.setIcon(r,"navigate-glyph")}renderCardDesc(t,n){this.plugin.log("TrelloView.renderCardDesc","");const r=n.createDiv("trello-card-desc--container"),i=r.createEl("a",{text:"Description",cls:"trello-card-desc--collapse",href:"#"}),o=i.createSpan("trello-card-desc--collapse-icon");e.setIcon(o,"down-chevron-glyph");const s=r.createDiv({cls:"trello-card-desc--desc"});e.MarkdownRenderer.renderMarkdown(t.desc,s,"",this),i.addEventListener("click",(()=>{s.style.maxHeight?(s.style.maxHeight="",e.setIcon(o,"down-chevron-glyph")):(s.style.maxHeight=s.scrollHeight+"px",e.setIcon(o,"up-chevron-glyph"))}))}renderLabels(e,t){this.plugin.log("TrelloView.renderLabels",""),e.labels.forEach((e=>{if(e.color){t.createDiv({cls:"trello-label-wrapper",attr:{"aria-label":""!==e.name?e.name:null}}).createSpan({cls:`trello-label trello-color--${e.color}`})}}))}renderCommentSection(t,n,r){this.plugin.log("TrelloView.renderCommentSection","");const i=r.createDiv("trello-comment-input--container"),o=i.createDiv({cls:"trello-comment-input--input-container"}).createEl("textarea",{cls:"trello-comment-input--input",attr:{onInput:"this.parentNode.dataset.replicatedValue = this.value",placeholder:"Write a comment..."}});i.createEl("button",{cls:"trello-comment-input--submit",text:"Submit",attr:{type:"button"}}).addEventListener("click",(()=>{o.value&&this.plugin.api.addCommentToCard(t.id,o.value).pipe(Ue((()=>{o.value=""}))).subscribe((()=>{this.update.next(),new e.Notice("Added comment.")}))})),n&&0!==n.length&&n.forEach((e=>{this.renderComment(e,r)}))}renderComment(t,n){this.plugin.log("TrelloView.renderComment","");const r=n.createDiv("trello-comment--container"),i=r.createDiv("trello-comment--metadata");i.createSpan({text:t.memberCreator.fullName,cls:"trello-comment--creator"}),i.createSpan({text:new Date(t.date).toLocaleString(),cls:"trello-comment--date"});const o=r.createDiv("trello-comment--text-container");e.MarkdownRenderer.renderMarkdown(t.data.text,o,"",this)}renderChecklistSection(e,t,n){this.plugin.log("TrelloView.renderChecklistSection","");const r=n.createDiv("trello-checklist--section"),i=new Ke(r);t.forEach((t=>{this.renderChecklist(e,t,i)}))}renderChecklist(e,t,n){this.plugin.log("TrelloView.renderChecklist","");const r=n.addSection(t.name),i=r.titleEl.querySelector(".trello-accordion--title-text"),o=null==i?void 0:i.createSpan({cls:"trello-checklist--accordion-percent"}),s=r.contentEl.createDiv("trello-checklist--progress-container"),l=s.createSpan("trello-checklist--progress-percent"),a=s.createEl("progress",{cls:"trello-checklist--progress",attr:{max:100}});this.updateProgress(t.checkItems,a,l,o);const c=r.contentEl.createEl("ul","trello-checklist--checklist");t.checkItems.forEach(((n,r)=>{const i=`checkitem-${n.id}`,s=c.createEl("li","trello-checklist--checkitem"),u=s.createEl("input",{cls:"trello-checklist--checkitem-input",attr:{type:"checkbox",id:i}});u.checked=n.state===fe.Complete,u.addEventListener("change",(i=>{i.preventDefault();let s=fe.Complete;u.checked||(s=fe.Incomplete),this.plugin.api.updateCheckItemState(e,n.id,s).subscribe((e=>{u.checked=e.state===fe.Complete;const n=[...t.checkItems];n[r].state=e.state,this.updateProgress(n,a,l,o),delete this.plugin.state.listCache[t.id]}))})),s.createEl("label",{cls:"trello-checklist--checkitem-label",text:n.name,attr:{for:i}})}))}renderNavButton(t,n,r,i){this.plugin.log("TrelloView.renderNavButton","");const o=t.createDiv({cls:"nav-action-button",attr:{"aria-label":n}});e.setIcon(o,r),o.addEventListener("click",i)}getWorstError(e){this.plugin.log("TrelloView.getWorstError","");let t=null;return e.forEach((e=>{switch(t){case null:case he.NoToken:null!==e&&(t=e);break;case he.RateLimit:e===he.Unauthorized&&(t=e)}})),t}updateProgress(e,t,n,r){this.plugin.log("TrelloView.updateProgress","");const i=e.filter((e=>e.state===fe.Complete)),o=e.length>0?Math.round(i.length/e.length*100):0;t.value=o,n.innerText=`${o}%`,r.innerText=`(${i.length}/${e.length})`}}class dt{constructor(e){this.plugin=e}getPropertyValue(e,t){var n;const r=this.plugin.app.metadataCache.getFileCache(t);return null===(n=null==r?void 0:r.frontmatter)||void 0===n?void 0:n[e]}updateOrCreateMeta(e,t,n){return n?K(this.plugin.app.fileManager.processFrontMatter(n,(n=>{n[e]=t}))):F}deleteProperty(e,t){return r(this,void 0,void 0,(function*(){if(t)return this.plugin.app.fileManager.processFrontMatter(t,(t=>{void 0!==t[e]&&delete t[e]}))}))}}function ht(e,t){!function(e,t){const n=We.customUi.global,r=Object.assign({},t);Object.keys(t).forEach((e=>{r[e]=Object.assign({},n,t[e])})),e.state.updateSetting("customUi",r)}(e,t.settings.customUi),e.state.updateVersion()}let pt=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_"),"");class gt extends e.Plugin{constructor(){super(...arguments),this.yamlHandler=new dt(this),this.destroy=new N,this.boardSuggestModal=new Xe(this.app),this.cardCreateModal=new et(this.app,this),this.cardSuggestModal=new tt(this.app),this.listSuggestModal=new rt(this.app)}onload(){return r(this,void 0,void 0,(function*(){const t=yield this.loadData(),n=Object.assign({},Ge,t);n.settings=Object.assign({},We,null==t?void 0:t.settings),n.settings.customUi=Object.assign({},We.customUi,null==t?void 0:t.settings.customUi),this.state=new it(this,n),this.api=new lt(this),this.customizeUIModal=new nt(this.app,this),e.addIcon(Fe.id,Fe.svgContent),t&&t.version!==Ge.version&&ht(this,n),this.state.settings.pipe($e(this.destroy)).subscribe((e=>{this.state.currentToken.next(e.token),this.state.verboseLogging.next(e.verboseLogging)})),this.registerView("trello-plugin",(e=>this.view=new ut(this,e))),this.registerEvent(this.app.workspace.on("file-open",(e=>r(this,void 0,void 0,(function*(){return this.handleFile(e)}))))),this.handleFile(this.app.workspace.getActiveFile()),this.addSettingTab(new at(this.app,this)),this.addCommand({id:"trello-plugin-connect-card",name:"Connect Trello card",callback:this.connectTrelloCard.bind(this),icon:"link"}),this.addCommand({id:"trello-plugin-disconnect-card",name:"Disconnect Trello card",callback:this.disconnectTrelloCard.bind(this),icon:"trash"}),this.addCommand({id:"trello-plugin-reveal-leaf",name:"Show Trello view",callback:()=>{this.revealTrelloLeaf(!0)},icon:Fe.id}),n.firstRun&&(this.revealTrelloLeaf(!0),this.state.completedFirstRun())}))}onunload(){this.destroy.next(),this.destroy.complete(),this.app.workspace.detachLeavesOfType("trello-plugin")}openTrelloSettings(){this.log("TrelloPlugin.openTrelloSettings","Opening settings"),this.app.setting.openTabById("obsidian-trello"),this.app.setting.open()}log(e,t,n=me.Info){if(this.state.verboseLogging.value){const r=`OBISIDAN-TRELLO: (${e}) ${t}`;switch(n){case me.Warn:console.warn(r);break;case me.Error:console.error(r);break;case me.Info:default:console.log(r)}}}handleFile(e){return r(this,void 0,void 0,(function*(){if(!e)return;const t=yield this.yamlHandler.getPropertyValue(qe.BoardCard,e);let n=yield this.yamlHandler.getPropertyValue(qe.TrelloId,e);if(t&&!n){const r=pt(),[i,o]=t.split(";");yield this.yamlHandler.updateOrCreateMeta(qe.TrelloId,r,e),this.state.updateConnectedCard(r,{boardId:i,cardId:o}),n=r}if(!t)return this.log("TrelloPlugin.handleFile","File not trello connected"),this.state.boardCardId.next(null),void this.state.connectedCardId.next(null);this.log("TrelloPlugin.handleFile",`File trello connected, board/card ID ${t}, plugin ID ${n}`),this.state.boardCardId.next(t),this.state.connectedCardId.next(n)}))}connectTrelloCard(){const t=this.app.workspace.getActiveFile();if(!t)return void this.log("TrelloPlugin.connectTrelloCard","No file available to connect trello card.",me.Warn);let n;this.log("TrelloPlugin.connectTrelloCard","Connecting trello card"),this.state.settings.pipe(Oe(1),ce((e=>e.selectedBoards)),Be((e=>De((()=>e.length>0),le(e),this.api.getBoards()))),Ue((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Got boards")})),Be((e=>this.selectBoard(e))),Ue((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Selected board ${e.id}`),n=e})),Be((e=>this.api.getCardsFromBoard(e.id))),Ue((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Got ${e.length} cards.`)})),Be((e=>this.selectCard(e))),Ue((e=>{this.log("TrelloPlugin.connectTrelloCard",`-> Selected card ${e.id}`)})),Be((e=>De((()=>e===Ye),this.addNewCard(n).pipe(Ue((()=>{this.log("TrelloPlugin.connectTrelloCard","Beginning add new card flow.")}))),le(e).pipe(Ue((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Selected existing card")})))))),Be((e=>Ae({selectedCard:le(e),existingId:le(this.yamlHandler.getPropertyValue(qe.TrelloId,t))}))),ce((({selectedCard:e,existingId:t})=>{const n=t||pt();this.log("TrelloPlugin.connectTrelloCard",`-> Updating file with plugin ID ${n}`),this.state.updateConnectedCard(n,{cardId:e.id,boardId:e.idBoard}),this.state.connectedCardId.next(n);const r=`${e.idBoard};${e.id}`;return this.log("TrelloPlugin.connectTrelloCard",`-> Updating file with board/card ID ${r}`),this.state.boardCardId.next(r),{boardCardId:r,trelloId:n}})),Be((({boardCardId:e,trelloId:n})=>function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Le()(re(e,se(e)))}(this.yamlHandler.updateOrCreateMeta(qe.TrelloId,n,t).pipe(Ue((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Adding plugin ID meta key.")}))),this.yamlHandler.updateOrCreateMeta(qe.BoardCard,e,t).pipe(Ue((()=>{this.log("TrelloPlugin.connectTrelloCard","-> Adding board/card ID meta key.")}))))))).subscribe({next:()=>{this.log("TrelloPlugin.connectTrelloCard","-> Done connecting card."),this.revealTrelloLeaf(!0)},error:t=>{t===he.Abort?this.log("TrelloPlugin.connectTrelloCard","-> Aborting connect flow."):t===he.Unauthorized?(this.log("TrelloPlugin.connectTrelloCard","-> API returned unauthorized.",me.Error),new e.Notice(He)):t===he.RateLimit?(this.log("TrelloPlugin.connectTrelloCard","-> API returned rate limit error.",me.Error),new e.Notice(ze)):t===he.NoToken?(this.log("TrelloPlugin.connectTrelloCard","-> No token present.",me.Error),new e.Notice(Re)):t===he.Unknown&&(this.log("TrelloPlugin.connectTrelloCard","-> Caught unknown error.",me.Error),new e.Notice(Qe))}})}disconnectTrelloCard(){return r(this,void 0,void 0,(function*(){const e=this.app.workspace.getActiveFile();if(!e)return void this.log("TrelloPlugin.disconnectTrelloCard","No file available to connect trello card.",me.Warn);this.log("TrelloPlugin.disconnectTrelloCard","Disconnecting trello connected card.");const t=this.yamlHandler.getPropertyValue(qe.TrelloId,e);t&&(yield this.yamlHandler.deleteProperty(qe.TrelloId,e),this.state.updateConnectedCard(t,null),this.state.connectedCardId.next(null),this.log("TrelloPlugin.disconnectTrelloCard","-> Removed plugin ID.")),yield this.yamlHandler.deleteProperty(qe.BoardCard,e),this.state.boardCardId.next(null),this.log("TrelloPlugin.disconnectTrelloCard","-> Removed board/card ID.")}))}selectBoard(e){return this.boardSuggestModal.options=e,this.boardSuggestModal.open(),this.boardSuggestModal.selected.pipe(Oe(1))}selectCard(e){return this.cardSuggestModal.options=e,this.cardSuggestModal.open(),this.cardSuggestModal.selected.pipe(Oe(1))}addNewCard(e){return Ae({labels:this.api.getLabelsFromBoard(e.id),list:this.api.getListsFromBoard(e.id).pipe(Be((e=>(this.listSuggestModal.options=e,this.listSuggestModal.open(),this.listSuggestModal.selected))),Oe(1)),settings:this.state.settings.pipe(Oe(1))}).pipe(Be((({labels:t,list:n,settings:r})=>(this.log("TrelloPlugin.addNewCard","-> All add new card observables emitted, setting up card create modal."),this.cardCreateModal.board=e,this.cardCreateModal.list=n,this.cardCreateModal.labels=t,this.cardCreateModal.defaultPosition=r.newCardPosition,this.cardCreateModal.open(),this.cardCreateModal.createdCard))),Oe(1))}revealTrelloLeaf(e=!1){this.log("TrelloPlugin.revealTrelloLeaf","Revealing trello leaf.");const t=this.app.workspace.getLeavesOfType("trello-plugin");0===t.length?(this.log("TrelloPlugin.revealTrelloLeaf","-> No trello leaf found, creating."),this.state.settings.pipe(Oe(1),ce((e=>e.openToSide))).subscribe((t=>{this.log("TrelloPlugin.revealTrelloLeaf",`-> Creating leaf on ${t} side.`);const n=t===pe.Right?this.app.workspace.getRightLeaf(!1):this.app.workspace.getLeftLeaf(!1);n.setViewState({type:"trello-plugin"}),e&&(this.log("TrelloPlugin.revealTrelloLeaf","-> Leaf created, revealing."),this.app.workspace.revealLeaf(n))}))):e&&(this.log("TrelloPlugin.revealTrelloLeaf","-> Trello leaf found, revealing."),this.app.workspace.revealLeaf(t[0]))}}module.exports=gt;
